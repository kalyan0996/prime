name: Tar SCP Extract & Docker Deploy

on:
  push:
    branches: [save-dev]

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      CONTAINER_NAME: ${{ secrets.STAGING_CONTAINER_NAME }}
      CONTAINER_PORT: ${{ secrets.STAGING_CONTAINER_PORT }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create archive
        run: |
          tar \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='node_modules' \
            --ignore-failed-read \
            -czf project.tar.gz .

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.STAGING_PRIVATE_KEY }}" > ~/.ssh/staging_key
          chmod 600 ~/.ssh/staging_key

      - name: Upload archive
        run: |
          scp -i ~/.ssh/staging_key \
            -o StrictHostKeyChecking=no \
            project.tar.gz \
            ${{ secrets.STAGING_USER }}@${{ secrets.STAGING_HOST }}:${{ secrets.STAGING_DIR }}/project.tar.gz

      - name: Deploy on Server
        run: |
          ssh -i ~/.ssh/staging_key \
            -o StrictHostKeyChecking=no \
            ${{ secrets.STAGING_USER }}@${{ secrets.STAGING_HOST }} << 'EOF'

          set -e

          BASE_DIR="${{ secrets.STAGING_DIR }}"
          APP_DIR="$BASE_DIR/${{ secrets.STAGING_CONTAINER_NAME }}/${{ secrets.STAGING_CONTAINER_PORT }}"

          mkdir -p "$APP_DIR"

          echo "ðŸ“¦ Extracting app..."
          tar -xzf "$BASE_DIR/project.tar.gz" -C "$APP_DIR"
          rm -f "$BASE_DIR/project.tar.gz"

          echo "ðŸ§ª Writing .env"
          cat > "$APP_DIR/.env" <<ENV
          ${{ secrets.STAGING_ENV }}
          ENV

          cd "$APP_DIR"

          echo "ðŸš€ Building Docker image..."
          docker build -t "${{ secrets.STAGING_CONTAINER_NAME }}" .

          echo "ðŸ§¹ Removing old container..."
          docker rm -f "${{ secrets.STAGING_CONTAINER_NAME }}" || true
          echo "ðŸš€ Running container..."
          docker run -d \
            --name "${{ secrets.STAGING_CONTAINER_NAME }}" \
            --restart always \
            --env-file .env \
            -p "${{ secrets.STAGING_CONTAINER_PORT }}:${{ secrets.STAGING_CONTAINER_PORT }}" \
            "${{ secrets.STAGING_CONTAINER_NAME }}"
          echo "ðŸ”¥ Cleaning .env"
          shred -u .env || rm -f .env

          echo "âœ… Deploy successful"
          EOF

      - name: Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/staging_key
